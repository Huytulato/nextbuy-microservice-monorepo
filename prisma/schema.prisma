// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Define data model(s) in the schema below and run `npx prisma db push` to deploy them to your database.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model images {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  file_id   String
  url       String
  userId    String? @db.ObjectId
  shopId    String? @db.ObjectId
  users     users? @relation(fields: [userId], references: [id])  
  shops     shops? @relation(fields: [shopId], references: [id])
  products  products? @relation(fields: [productsId], references: [id])
  productsId String? @db.ObjectId 
}

model users {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String @unique
  password  String?
  followingIDs String[] @db.ObjectId
  following    shops[]  @relation(fields: [followingIDs], references: [id])
  images  images[]
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt
  reviews   shopReviews[]
  addresses shipping_addresses[]
  orders    orders[]
}

model shopReviews {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String @db.ObjectId
  shopId    String @db.ObjectId
  rating    Float
  reviews   String?
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt

  users     users @relation(fields: [userId], references: [id])
  shops     shops @relation(fields: [shopId], references: [id])
}

model shops {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  bio         String?
  category    String
  images  images[]
  coverBanner String?
  avatar      String? // Shop Logo/Avatar
  address     String
  opening_hours String
  website     String?
  social_links Json[]
  shippingSettings Json? // Shipping configuration: {fee: number, methods: string[], estimatedDays: number}
  rating      Float @default(0)
  reviews     shopReviews[]
  sellerId    String @db.ObjectId @unique
  sellers     sellers @relation(fields: [sellerId], references: [id])
  followerIDs String[] @db.ObjectId
  followers   users[]  @relation(fields: [followerIDs], references: [id])
  createdAt   DateTime @default(now())
  updateAt    DateTime @updatedAt
  products    products[]
  orders      orders[]
}

model sellers {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  email       String @unique
  phone_number String @unique
  country     String
  password    String
  stripeId    String? @unique
  shops       shops?
  createdAt   DateTime @default(now())
  updateAt    DateTime @updatedAt
  verificationStatus VerificationStatus @default(UNVERIFIED)
  documents          Json?
  rejectionReason    String?
  verifiedAt         DateTime?
  submittedAt        DateTime?
  reviewedBy         String? @db.ObjectId
  reviewedAt         DateTime?
  adminNotes         String?
  resubmissionCount  Int @default(0)
  reviewer           admins? @relation("AdminReviewedSellers", fields: [reviewedBy], references: [id])
  verificationHistory seller_verification_history[]
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  APPROVED
  REJECTED
}

model seller_verification_history {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  sellerId      String   @db.ObjectId
  status        VerificationStatus
  reviewedBy    String? @db.ObjectId
  notes         String?
  documents     Json?
  createdAt     DateTime @default(now())
  
  seller        sellers @relation(fields: [sellerId], references: [id])
  reviewer      admins? @relation("AdminSellerVerificationHistory", fields: [reviewedBy], references: [id])
}

model site_config {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  categories  String[]
  subCategories Json
}

model discount_codes {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  public_name String
  discountType String
  discountValue Float
  discountCode String @unique
  sellerId    String @db.ObjectId
  createdAt   DateTime @default(now())
  updateAt    DateTime @updatedAt
  orders      orders[]
}

enum productStatus {
  active
  pending
  draft
  rejected
  hidden
  banned
  deleted
}

model products {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  title                String
  slug                 String    @unique
  category             String
  subCategory          String
  short_description    String
  detailed_description String
  images               images[]
  video_url            String?
  tags                 String[]
  brand                String?
  colors               String[]
  sizes                String[]
  starting_date        DateTime
  ending_date          DateTime
  stock                Int
  sale_price           Float
  regular_price       Float
  ratings              Float    @default(0)
  warranty             String?
  custom_specifications Json?
  custom_properties    Json
  isDeleted            Boolean  @default(false)
  cashOnDelivery       String?
  discount_codes       String[] @db.ObjectId
  status               productStatus @default(pending)
  rejectionReason      String?
  isAutoModerated      Boolean   @default(false)
  moderationScore      Float?
  deletedAt            DateTime?
  submittedAt          DateTime?
  reviewedBy           String? @db.ObjectId
  reviewedAt           DateTime?
  lastReviewedAt       DateTime?
  requiresReReview     Boolean @default(false)
  adminNotes           String?
  createdAt           DateTime @default(now())
  updateAt            DateTime @updatedAt
  shopId               String   @db.ObjectId
  shops                shops    @relation(fields: [shopId], references: [id])
  reviewer             admins? @relation("AdminReviewedProducts", fields: [reviewedBy], references: [id])
  orderItems           order_items[]
  history              product_history[]
  variations           product_variations[]
  variationGroups      variation_groups[]
  hasVariations        Boolean @default(false)
}

model variation_groups {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  productId   String   @db.ObjectId
  name        String   // "Color", "Size", "Material", etc.
  options     String[] // ["Red", "Blue", "Green"] or ["S", "M", "L"]
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     products @relation(fields: [productId], references: [id])
  
  @@index([productId])
}

model product_variations {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  productId     String   @db.ObjectId
  sku           String   @unique
  attributes    Json     // {"color": "Red", "size": "M"}
  price         Float
  stock         Int
  isActive      Boolean  @default(true)
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  hasOrders     Boolean  @default(false) // Track if this variation has orders (prevent hard delete)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  product       products @relation(fields: [productId], references: [id])
  orderItems    order_items[]
  
  @@index([productId])
  @@index([isActive, isDeleted])
}

model product_history {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  productId   String   @db.ObjectId
  changedBy   String
  changeType  String   // "edit", "moderation_approve", "moderation_reject", "auto_moderation"
  changes     Json
  reason      String?
  createdAt   DateTime @default(now())
  product     products @relation(fields: [productId], references: [id])
}

model userAnalytics {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @unique
  lastVisited DateTime
  actions     Json[]   // Array of {productId, shopId, action, timestamp}
  country     String?
  city        String?
  device      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model productAnalytics {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  productId    String   @unique
  shopId       String?  @db.ObjectId
  views        Int      @default(0)
  cartAdds     Int      @default(0)
  cartRemoves  Int      @default(0)
  wishListAdds Int      @default(0)
  wishListRemoves Int   @default(0)
  purchases    Int      @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model admins {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String @unique
  password  String
  role      String?
  createdAt DateTime @default(now())
  updateAt  DateTime @updatedAt
  reviewedSellers   sellers[] @relation("AdminReviewedSellers")
  reviewedProducts  products[] @relation("AdminReviewedProducts")
  sellerVerificationHistory seller_verification_history[] @relation("AdminSellerVerificationHistory")
}

model shipping_addresses {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  fullName   String
  phone      String
  address    String
  city       String
  province   String
  postalCode String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updateAt   DateTime @updatedAt
  users      users    @relation(fields: [userId], references: [id])
  orders     orders[]
}

enum deliveryStatus {
  ordered
  packed
  shipped
  out_for_delivery
  delivered
}

model orders {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  userId            String          @db.ObjectId
  shopId            String          @db.ObjectId
  total             Float
  status            String
  deliveryStatus    deliveryStatus  @default(ordered)
  shippingAddressId String?         @db.ObjectId
  couponCode        String?
  discountAmount    Float           @default(0)
  createdAt         DateTime        @default(now())
  updateAt          DateTime        @updatedAt

  user              users           @relation(fields: [userId], references: [id])
  shop              shops           @relation(fields: [shopId], references: [id])
  shippingAddress   shipping_addresses? @relation(fields: [shippingAddressId], references: [id])
  coupon            discount_codes? @relation(fields: [couponCode], references: [discountCode])
  items             order_items[]
}

model order_items {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId        String   @db.ObjectId
  productId      String   @db.ObjectId
  variationId    String?  @db.ObjectId  // Link to specific variation
  quantity       Int
  price          Float
  selectedOptions Json?
  createdAt      DateTime @default(now())
  updateAt       DateTime @updatedAt

  order          orders   @relation(fields: [orderId], references: [id])
  product        products @relation(fields: [productId], references: [id])
  variation      product_variations? @relation(fields: [variationId], references: [id])
  
  @@index([variationId])
}

model notifications {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  message       String
  creatorId     String
  receiverId    String
  redirect_link String
  isRead        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updateAt      DateTime @updatedAt
}

model moderation_config {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  bannedKeywords        String[]
  sensitiveCategories   String[]
  autoApproveThreshold  Int      @default(90)
  updatedBy             String?  @db.ObjectId
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
